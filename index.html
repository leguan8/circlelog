<!-- index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>åœˆè®° Circlelog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #f7f7f7; display: flex; flex-direction: column; align-items: center; }
    .title { margin: 16px; font-size: 24px; text-align: center; }
    .cont { margin: 16px; font-size: 16px; text-align: center; }
    #map-container { width: 95%; max-width: 800px; height: 70vh; border-radius: 10px; overflow: hidden; box-shadow: 0 0 12px rgba(0,0,0,0.2); margin-bottom: 20px; }
    #map { width: 100%; height: 100%; }
    .leaflet-popup-content img { width: 100%; border-radius: 6px; margin-top: 6px; }
    .leaflet-popup-content strong { font-size: 16px; }
    #timeline { display: flex; flex-direction: column; overflow-y: auto; max-height: 300px; gap: 12px; padding: 6px; text-align: center; }
    .day-buttons { display: flex; overflow-x: auto; gap: 4px; padding: 4px 0; }
    .date-button { padding: 3px 6px; border-radius: 4px; background: #eee; border: none; cursor: pointer; }
    .date-button.active { background: #007bff; color: white; }
    #random-btn { margin: 8px; padding: 6px 14px; font-size: 14px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="title">ã€Šåœˆè®° Circlelogã€‹â€”â€”åœ¨çº¸ä¸Šç”»åœˆï¼Œåœ¨æ—¶å…‰å­˜æ¡£</div>
  <div class="cont">â€œå½“æˆ‘ç”»ç¬¬ä¸€ä¸ªåœ†ï¼Œæˆ‘åœ¨ç”»å®ƒï¼›å½“æˆ‘ç”»ç¬¬ä¸€ç™¾ä¸ªåœ†ï¼Œå®ƒåœ¨ç”»æˆ‘ã€‚â€</div>
  <button id="random-btn" onclick="jumpToRandom()">ğŸ² éšæœºè·³è½¬ä¸€å¹…åœˆè®°</button>
  <div id="timeline">
    <div>
      <label>å¹´ä»½ï¼š</label>
      <select id="year-select"></select>
      <label style="margin-left:12px;">æœˆä»½ï¼š</label>
      <select id="month-select"></select>
    </div>
    <div id="day-buttons" class="day-buttons"></div>
  </div>

  <div id="map-container"><div id="map"></div></div>

  <script src="https://cdnjs.loli.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.loli.net/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
  <script>
    let allMarkers = [], markerMap = {}, stories = {}, artworks = [];

    fetch("data/stories.json").then(r => r.json()).then(j => { stories = j; });

    const map = L.map("map").setView([39.92, 116.38], 13);
    L.tileLayer("https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=Kraj4sMruVnY2JOZ3xff", {
      attribution: "Â© MapTiler & OpenStreetMap contributors", tileSize: 512, zoomOffset: -1
    }).addTo(map);

    fetch("data/artworks.json").then(r => r.json()).then(data => {
      artworks = data;
      const clusterGroup = L.markerClusterGroup();
      const byMonth = {};
      data.forEach(work => {
        const coordKey = work.coordinates.join(",");
        const date = work.time || "æœªçŸ¥";
        const [year, month] = date.split("-");
        const yyyymm = `${year}-${month}`;
        if (!byMonth[yyyymm]) byMonth[yyyymm] = [];
        byMonth[yyyymm].push({ ...work, coordKey });

        const html = generatePopup(work, coordKey);
        const icon = L.icon({
          iconUrl: work.collected ? 'images/red-marker.png' : 'images/blue-marker.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowUrl: 'https://cdnjs.loli.net/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
          shadowSize: [41, 41]
        });

        const marker = L.marker(work.coordinates, { icon }).bindPopup(html);
        marker.on("click", () => {
          map.setView(work.coordinates, 16, { animate: true, pan: { duration: 1 } });
          map.once('moveend', () => {
            marker.openPopup();
            Fancybox.bind("[data-fancybox]", { hideScrollbar: false });
            showRandomLine(work.weather || "clear", coordKey);
            highlightTimeline(work.time);
          });
        });

        allMarkers.push({ marker, coords: work.coordinates });
        markerMap[coordKey] = marker;
        clusterGroup.addLayer(marker);
      });
      map.addLayer(clusterGroup);
      buildTimeline(byMonth);
    });

    function generatePopup(work, coordKey) {
      const icon = work.collected ? "ğŸ”´å·²è¢«æ”¶è—" : "âšª";
      let photosHtml = "";
      if (work.photos && work.photos.length > 0) {
        photosHtml = `<div><strong>åˆ›ä½œè®°å½•ï¼š</strong><div style="display:flex;gap:4px;flex-wrap:wrap;">`;
        work.photos.forEach((photo, idx) => {
          photosHtml += `<a data-fancybox="photos-${coordKey}" href="${photo}" data-caption="åˆ›ä½œçºªå® ${idx + 1}"><img src="${photo}" alt="åˆ›ä½œç…§ç‰‡" style="width:48px;height:48px;object-fit:cover;border-radius:4px;" /></a>`;
        });
        photosHtml += `</div></div>`;
      }

      return `<div>
        <strong>${work.title || "æ— æ ‡é¢˜"} </strong>${icon}<br/>
        <div class="random-line" id="line-${coordKey}">åœˆè®° Â· è®°å½•ç€æ¯ä¸ªç¬é—´çš„å…‰å½±ã€‚</div>
        <a data-fancybox="gallery-${coordKey}" href="${work.image}" data-caption="${work.title}"><img src="${work.image}" alt="ä½œå“å›¾" /></a>
        <div><small>æ—¶é—´ï¼š${work.time || "æœªçŸ¥"} ï½œ å¤©æ°”ï¼š${work.weather || "æœªçŸ¥"}</small></div>
        <p>${work.notes || ""}</p>
        ${photosHtml}
      </div>`;
    }

    function showRandomLine(weather, coordKey) {
      const lines = stories[weather] || stories["clear"] || [];
      const text = lines.length ? lines[Math.floor(Math.random() * lines.length)] : "æš‚æ— éšæœºå¥å­";
      document.getElementById("line-" + coordKey).innerText = text;
    }

    function buildTimeline(grouped) {
      const yearSelect = document.getElementById("year-select");
      const monthSelect = document.getElementById("month-select");
      const dayButtons = document.getElementById("day-buttons");
      const yearMap = {};

      Object.entries(grouped).forEach(([ym, works]) => {
        const [y, m] = ym.split("-");
        if (!yearMap[y]) yearMap[y] = {};
        yearMap[y][m] = works;
      });

      const years = Object.keys(yearMap).sort().reverse();
      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.text = y;
        yearSelect.appendChild(opt);
      });

      yearSelect.onchange = () => {
        const y = yearSelect.value;
        monthSelect.innerHTML = "";
        Object.keys(yearMap[y] || {}).sort().forEach(m => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.text = m;
          monthSelect.appendChild(opt);
        });
        monthSelect.onchange();
      };

      monthSelect.onchange = () => {
        const y = yearSelect.value;
        const m = monthSelect.value;
        const works = (yearMap[y] && yearMap[y][m]) || [];
        dayButtons.innerHTML = "";
        works.forEach(w => {
          const btn = document.createElement("button");
          const icon = w.collected ? "ğŸ”´" : "âšª";
          btn.className = "date-button";
          btn.textContent = `${icon} ${w.time.split("-")[2]}`;
          btn.onclick = () => {
            map.setView(w.coordinates, 16, { animate: true, pan: { duration: 1 } });
            map.once('moveend', () => {
              markerMap[w.coordKey].openPopup();
              Fancybox.bind("[data-fancybox]", { hideScrollbar: false });
              showRandomLine(w.weather || "clear", w.coordKey);
              highlightTimeline(w.time);
            });
          };
          btn.dataset.coord = w.coordKey;
          btn.dataset.date = w.time;
          dayButtons.appendChild(btn);
        });
      };

      if (years.length > 0) {
        yearSelect.value = years[0];
        yearSelect.onchange();
      }
    }

    function jumpToRandom() {
      if (!allMarkers.length) return;
      const { marker, coords } = allMarkers[Math.floor(Math.random() * allMarkers.length)];
      map.setView(coords, 16, { animate: true, pan: { duration: 1 } });
      map.once('moveend', () => {
        marker.openPopup();
        Fancybox.bind("[data-fancybox]", { hideScrollbar: false });
        const work = artworks.find(w => w.coordinates[0] === coords[0] && w.coordinates[1] === coords[1]);
        if (work) {
          const coordKey = work.coordinates.join(",");
          showRandomLine(work.weather || "clear", coordKey);
          highlightTimeline(work.time);
        }
      });
    }

    function highlightTimeline(dateStr) {
      const [year, month, day] = dateStr.split("-");
      const yearSelect = document.getElementById("year-select");
      const monthSelect = document.getElementById("month-select");
      const dayButtons = document.getElementById("day-buttons");

      if (yearSelect.value !== year) {
        yearSelect.value = year;
        yearSelect.onchange();
      }
      if (monthSelect.value !== month) {
        monthSelect.value = month;
        monthSelect.onchange();
      }

      setTimeout(() => {
        const buttons = dayButtons.querySelectorAll(".date-button");
        buttons.forEach(btn => {
          btn.classList.remove("active");
          if (btn.dataset.date === dateStr) {
            btn.classList.add("active");
            btn.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
          }
        });
      }, 100);
    }
  </script>
</body>
</html>
